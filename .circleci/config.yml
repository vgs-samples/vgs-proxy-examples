version: 2
executorType: machine
jobs:
  build:
    working_directory: ~/vault-examples
    docker:
    environment:
      FORWARD_HTTP_PROXY_USERNAME: USgZBYM6MVyd3eG2g7Gf3wc8
      FORWARD_HTTP_PROXY_PASSWORD: 211171fb-9323-4e3a-84f3-f0004ab0c21c
      FORWARD_HTTP_PROXY_HOST: tntzanp4lia.SANDBOX.verygoodproxy.com:8080
      REVERSE_HTTP_PROXY_HOST: tntzanp4lia.SANDBOX.verygoodproxy.com
    machine:
      image: circleci/classic:edge
    steps:
      - checkout

      - run: docker-compose -f php/docker-compose.yml build
      - run: docker-compose -f php/docker-compose.yml up
      - run: docker-compose -f php/docker-compose.yml run example php example.php

      - run: docker build --build-arg BASE_IMAGE_TAG=2 -t python2-example python/
      - run: docker build -t python3-example python/
      - run: docker run -t --env-file <(env | grep HTTP_PROXY) python2-example
      - run: docker run -t --env-file <(env | grep HTTP_PROXY) python3-example

      - run: docker build -t ruby2-example ruby/
      - run: docker run -t --env-file <(env | grep HTTP_PROXY) ruby2-example

      - run: docker-compose -f selenium/docker-compose.yml build
      - run: docker-compose -f selenium/docker-compose.yml up -d
      - run: docker-compose -f selenium/docker-compose.yml run example python example.py
      - run: docker-compose -f selenium/docker-compose.yml down

      - run: docker build -t nodejs-example nodejs/
      - run: docker run -t --env-file <(env | grep HTTP_PROXY) nodejs-example

      - run: docker build -t go-example go/
      - run: docker run -t --env-file <(env | grep HTTP_PROXY) go-example

      - run: docker build -t java-example java/
      - run: docker run -t --env-file <(env | grep HTTP_PROXY) java-example

      - run: docker build -t cs-example cs/
      - run: docker run -t --env-file <(env | grep HTTP_PROXY) cs-example

      - run: docker build -t scala-example scala/
      - run: docker run -t --env-file <(env | grep HTTP_PROXY) scala-example

      # - run: docker build -t rust-example rust/
      # - run: docker run -t --env-file <(env | grep HTTP_PROXY) rust-example 
      # Rust build is broken
      
      - run: docker build -t clang-example c99/
